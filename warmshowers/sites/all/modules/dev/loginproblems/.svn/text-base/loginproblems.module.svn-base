<?php

// $Id$

/**
 * @file
 * Login problem diagnosis
 * 
 */

function loginproblems_menu($may_cache) {
	$items = array();

	if ($may_cache) {
		$items[] = array(
			'path' => 'freshlogin',
			'title' => t("Fresh Login"),
			'callback' => 'loginproblems_freshlogin',
			'access' => true, 
			'type' => MENU_CALLBACK,
						
		);


	}

	return $items;
}

function loginproblems_form_alter($form_id, &$form) {
  if ($form_id == 'user_login_block' || $form_id == 'user_login')  {
// 	$browser = browscap_get_browser();
//
//
//  	if (!$browser['cookies']) {
//  		//$form['name']['submit']['#disabled'] = true;
//  		$form['#disabled'] = true;
//  		$form['explanation'] = array(
//  			'#type'=>'markup',
//  			'#value' => t("You don't have cookies turned on so you can't log in"),
//  			);
//  	} else {
//  		  $form['explanation'] = array(
//  			'#type'=>'markup',
//  			'#value' => t("According to the tester, you have cookies enabled so can log in"),
//  			);
//
//  		
//  	}
  	
  	$path = 'freshlogin';
    $form['#action'] = url($_GET['q'], "destination=$path");
  }
}


/**
 * Implementation of hook_user to catch when people log in.
 *
 */
function loginproblems_user($op) {
	global $user;
	
	if ($op == 'login') {
		// drupal_goto("newlogin");
	}
	
	
}



function loginproblems_freshlogin() {
	global $user;
	$query = "select from_unixtime(login) lastlogin from {users} 
		where uid=%d ";
	$result = db_query($query,$user->uid);;
	$theanswer = db_fetch_object($result);
	if (db_num_rows($result) && $user->uid) {
		$output .= "Your last login was on $theanswer->lastlogin";
	} else {
		$output = "Next time";
	}
	
	$browser = browscap_get_browser();
	
	if (!$user->uid) {
		$output.="<h2>It looks like you just tried to log in and cookies aren't turned on or aren't working for you. Please turne them on!</h2>";
	}
	
	return $output;
	
}